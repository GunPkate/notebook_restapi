var express = require('express')
var {Router, request} = require('express')
const mongoose = require('mongoose')
const router = express.Router();

// mongoose.connect('mongodb://localhost:27017/my_assets');
mongoose.connect('mongodb://localhost/my_assets')
    .then(()=>console.log('connected to MongoDB'))
        .catch(()=>console.error('Connection error: ',error));

    const notebookSchema = new mongoose.Schema({

        asset_code:{     type: String,require: true},
        brand:{         type: String,require: true   },
        model:{        type: String,require: true},
        serial:{        type: String,require: true},
        status:{        type: Boolean,require: true},
        warranty:{       type: Number,require: true},
        warranty_date:{  type: Date,require: true},
        purchase_date:{  type: Date,require: true},
        remark:{        type: String,}
    },
    { collection:'notebooks',versionKey: false}
    )

    const Notebooks = mongoose.model('notebooks',notebookSchema)

router.get('/notebook/getall',(req,res)=>{
    try {
        Notebooks.find({},function(error,findallnotebook){
            const result = findallnotebook;
            console.log("result: ",result);
            res.status(200).json(({
                resultCode: 20000,
                resultDescription: "success",
                resultData: result
            }));
        });
    } catch (error) {
        console.log("get api error",error)
    }
})

router.post('/notebook/create',async (req,res)=>{
    try {
    console.log(req.body.brand,": brand");
    const data = req.body
    console.log(data,"data");
    // Notebooks.find({"brand":`${req.body.brand}`,"serial":`${req.body.serial}`},(error,find_result)=>{

        Notebooks.find({"brand":`${req.body.brand}`},async (error,find_result)=>{
            console.log(find_result !== null | undefined)
            if(find_result){
                res.send({
                    "resultcode": 40900,
                    "resultDescription": "Duplicated data",
                })
            }else{
                  const creatednotebook = await Notebooks.create( {      
                    "brand" : data.brand,
                    "asset_code": data.asset_code,
                    "moidel" : data.model,
                    "serial" : data.serial,
                    "status": data.status,
                    "warranty" : data.status,
                    "warranty_date": data.warranty_date|Date.now(),
                    "purchase_date": data.purchase_date|Date.now(),
                    "remark": data.remark
                })
                console.log("created",creatednotebook)
                res.status(200).json({
                    resultCode: 20000,
                    resultDescription: `Notebook ${data.brand} created`,
                    resultData: creatednotebook
                })
            }
        })
    } catch (error) {
        res.status(500).json({
            resultCode: 50000,
            resultDescription: error.message
        })
    }
})

router.put('/notebook/update',(req,res)=>{
    try {
        const {asset_code} = req.body ,data = req.body
        // console.log(req.body)
        Notebooks.findOneAndUpdate({asset_code:asset_code},{
            "brand" : data.brand,
            "asset_code": data.asset_code,
            "model" : data.model,
            "serial" : data.serial,
            "status": data.status,
            // "purchase_date":data.purchase_date,
            "warranty" : data.status,
            "remark": data.remark
        },(err,founddata)=>{
            // console.log(founddata)
            res.status(200).json({
                resultCode: 20000,
                resultDescription: "Update Success",
                resultData: founddata
            })
        })
    } catch (error) {
        res.status(500).json({
            resultCode: 50000,
            resultDescription: error,
        })
    }
})

router.delete('/notebook/delete',(req,res)=>{
    Notebooks.findOneAndDelete({},(err,data)=>{
        console.log(data)
        if(data){

        }
    })
})

module.exports = router;